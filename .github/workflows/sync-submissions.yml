name: Sync Submissions CSV

on:
  schedule:
    # Run every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch: # Allow manual trigger

# Need write permissions to push changes
permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
      
      - name: Fetch CSV from private repo
        run: |
          curl -H "Authorization: Bearer ${{ secrets.PRIVATE_REPO_TOKEN }}" \
               -H "Accept: application/vnd.github.raw+json" \
               -H "X-GitHub-Api-Version: 2022-11-28" \
               -o public/submissions.csv \
               "https://api.github.com/repos/latchbio/latch-internal-evals/contents/submissions.csv?ref=main"
      
      - name: Update sync timestamp
        run: |
          echo "{\"lastSync\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > public/sync-status.json

      - name: Upload to Cloudflare R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
        run: |
          # Install AWS CLI (comes pre-installed on ubuntu-latest, but ensure it's available)
          aws --version

          # Upload submissions.csv to R2
          aws s3 cp public/submissions.csv s3://evaluations-data/submissions.csv \
            --endpoint-url "$R2_ENDPOINT" \
            --content-type "text/csv"

          # Upload sync-status.json to R2
          aws s3 cp public/sync-status.json s3://evaluations-data/sync-status.json \
            --endpoint-url "$R2_ENDPOINT" \
            --content-type "application/json"

          echo "Successfully uploaded files to R2"

      - name: Check for changes
        id: check_changes
        run: |
          git add public/submissions.csv public/sync-status.json
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -m "chore: sync submissions.csv from latch-internal-evals"
          git push
